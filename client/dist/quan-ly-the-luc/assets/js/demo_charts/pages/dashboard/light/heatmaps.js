var DashboardHeatmaps={init:function(){var t;t="#sales-heatmap","undefined"!=typeof d3?$(t).length>0&&d3.csv("../../../../global_assets/demo_data/dashboard/app_sales_heatmap.csv",function(e,a){var r=d3.nest().key(function(t){return t.app}).entries(a),n=d3.time.format("%Y/%m/%d %H:%M"),i=d3.time.format("%H:%M");a.forEach(function(t,e){t.date=n.parse(t.date),t.value=+t.value});var d=d3.select(t);margin={top:20,right:0,bottom:30,left:0},width=d.node().getBoundingClientRect().width-margin.left-margin.right,gridSize=width/new Date(a[a.length-1].date).getHours(),rowGap=40,height=(rowGap+gridSize)*d3.max(r,function(t,e){return e+1})-margin.top,buckets=5,colors=["#DCEDC8","#C5E1A5","#9CCC65","#7CB342","#558B2F"];var o=d3.time.scale().range([0,width]),s=d3.scale.linear().range([height,0]),l=d3.scale.quantile().domain([0,buckets-1,d3.max(a,function(t){return t.value})]).range(colors);o.domain([new Date(a[0].date),d3.time.hour.offset(new Date(a[a.length-1].date),1)]),s.domain([0,d3.max(a,function(t){return t.app})]);var u=d.append("svg"),c=u.attr("width",width+margin.left+margin.right).attr("height",height+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),g=c.selectAll(".hour-group").data(r).enter().append("g").attr("class","hour-group").attr("transform",function(t,e){return"translate(0, "+(gridSize+rowGap)*e+")"});g.append("text").attr("class","d3-text").attr("x",0).attr("y",-margin.top/2).text(function(t,e){return t.key}),g.append("text").attr("class","sales-count d3-text").attr("x",width).attr("y",-margin.top/2).style("text-anchor","end").text(function(t,e){return d3.sum(t.values,function(t){return t.value})+" sales today"});var h,m,p=g.selectAll(".heatmap-hour").data(function(t){return t.values}).enter().append("rect").attr("x",function(t,e){return o(t.date)}).attr("y",0).attr("class","heatmap-hour d3-slice-border d3-bg").attr("width",gridSize).attr("height",gridSize).style("cursor","pointer");p.transition().duration(250).delay(function(t,e){return 20*e}).style("fill",function(t){return l(t.value)}),g.each(function(t){p.on("mouseover",function(t,e){d3.select(this).style("opacity",.75),d3.select(this.parentNode).select(".sales-count").text(function(t){return t.values[e].value+" sales at "+i(t.values[e].date)})}).on("mouseout",function(t,e){d3.select(this).style("opacity",1),d3.select(this.parentNode).select(".sales-count").text(function(t,e){return d3.sum(t.values,function(t){return t.value})+" sales today"})})}),a.forEach(function(t,e){m=d3.max(a,function(t){return t.value}),h=d3.min(a,function(t){return t.value})});var f=c.append("g").attr("class","legend-group").attr("width",width).attr("transform","translate("+(width/2-buckets*gridSize/2)+","+(height+(margin.bottom-margin.top))+")");f.selectAll(".heatmap-legend").data([0].concat(l.quantiles()),function(t){return t}).enter().append("g").attr("class","heatmap-legend").append("rect").attr("class","heatmap-legend-item d3-slice-border").attr("x",function(t,e){return gridSize*e}).attr("y",-8).attr("width",gridSize).attr("height",5).style("stroke-width",1).style("fill",function(t,e){return colors[e]}),f.append("text").attr("class","min-legend-value d3-text").attr("x",-10).attr("y",-2).style("text-anchor","end").style("font-size",11).text(h),f.append("text").attr("class","max-legend-value d3-text").attr("x",buckets*gridSize+10).attr("y",-2).style("font-size",11).text(m),window.addEventListener("resize",v);var w=document.querySelector(".sidebar-control");function v(){width=d.node().getBoundingClientRect().width-margin.left-margin.right,gridSize=width/new Date(a[a.length-1].date).getHours(),height=(rowGap+gridSize)*d3.max(r,function(t,e){return e+1})-margin.top,u.attr("width",width+margin.left+margin.right).attr("height",height+margin.bottom),c.attr("width",width+margin.left+margin.right).attr("height",height+margin.bottom),o.range([0,width]),c.selectAll(".hour-group").attr("transform",function(t,e){return"translate(0, "+(gridSize+rowGap)*e+")"}),c.selectAll(".heatmap-hour").attr("width",gridSize).attr("height",gridSize).attr("x",function(t,e){return o(t.date)}),c.selectAll(".legend-group").attr("transform","translate("+(width/2-buckets*gridSize/2)+","+(height+margin.bottom-margin.top)+")"),c.selectAll(".sales-count").attr("x",width),c.selectAll(".heatmap-legend-item").attr("width",gridSize).attr("x",function(t,e){return gridSize*e}),c.selectAll(".max-legend-value").attr("x",buckets*gridSize+10)}w&&w.addEventListener("click",v)}):console.warn("Warning - d3.min.js is not loaded.")}};document.addEventListener("DOMContentLoaded",function(){DashboardHeatmaps.init()});